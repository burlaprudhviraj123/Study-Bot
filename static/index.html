<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Study Bot</title>

<!-- Markdown + Syntax Highlight -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>

<style>
/* ================= THEMES ================= */
:root {
  --bg: #0f0f10;
  --text: #e5e5e5;
  --border: #2a2a2a;
  --bot: #262626;
  --user: #fe9012;
  --input: #0f0f10;
}
body.light {
  --bg: #ffffff;
  --text: #1f2937;
  --border: #e5e7eb;
  --bot: #f0f0f0;
  --user: #e15f19;
  --input: #ffffff;
}
.docs-btn {
  text-decoration: none;
  font-size: 14px;
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid var(--border);
  color: var(--text);
  margin-right: 6px;
}

.docs-btn:hover {
  background: var(--bot);
}
/* ================= BASE ================= */
* { box-sizing: border-box; }
body {
  margin: 0;
  height: 100vh;
  display: flex;
  background: var(--bg);
  color: var(--text);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

/* ================= SIDEBAR ================= */
.sidebar {
  width: 240px;
  border-right: 1px solid var(--border);
  padding: 12px;
  display: flex;
  flex-direction: column;
}
.sidebar h3 {
  margin: 0 0 12px;
  font-size: 14px;
}
.chat-list button {
  background: none;
  border: none;
  color: var(--text);
  text-align: left;
  padding: 8px;
  border-radius: 6px;
  cursor: pointer;
}
.chat-list button:hover {
  background: var(--bot);
}
.clear-btn {
  margin-top: auto;
  background: #dc2626;
  color: white;
  border: none;
  padding: 8px;
  border-radius: 6px;
  cursor: pointer;
}

/* ================= MAIN ================= */
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
}

/* HEADER */
.header {
  height: 56px;
  padding: 0 12px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 600;
}
.header-right button {
  margin-left: 8px;
  cursor: pointer;
}

/* ================= CHAT ================= */
.messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px 8px 90px;
}
.inner {
  max-width: 1100px;
  margin: 0 auto;
}

/* Bubble animation */
@keyframes bubblePop {
  from {
    opacity: 0;
    transform: translateY(6px) scale(0.98);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.msg {
  width: fit-content;
  max-width: 94%;
  padding: 12px 14px;
  margin-bottom: 20px;
  border-radius: 12px;
  line-height: 1.6;
  white-space: pre-wrap;
  word-wrap: break-word;
  animation: bubblePop 0.18s ease-out;
}

/* BOT â†’ LEFT */
.bot {
  background: var(--bot);
  margin-right: auto;
  text-align: left;
  border-bottom-left-radius: 4px;
}

/* USER â†’ RIGHT */
.user {
  background: var(--user);
  color: #021b16;
  margin-left: auto;
  text-align: right;
  border-bottom-right-radius: 4px;
}

/* Code blocks always left-aligned */
.user pre,
.user code {
  text-align: left;
}

.copy {
  font-size: 12px;
  opacity: 0.7;
  cursor: pointer;
  margin-top: 6px;
}

/* ================= INPUT ================= */
.input {
  position: fixed;
  bottom: 0;
  width: 100%;
  border-top: 1px solid var(--border);
  background: var(--bg);
  padding: 10px 8px;
}
.input-inner {
  max-width: 1100px;
  margin: 0 auto;
  display: flex;
  gap: 10px;
}
input {
  flex: 1;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid var(--border);
  outline: none;
  background: var(--input);
  color: var(--text);
}
.send {
  background: var(--user);
  border: none;
  padding: 12px 16px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
}

/* ================= PROFILE ================= */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  justify-content: center;
  align-items: center;
}
.modal-content {
  background: var(--bg);
  padding: 20px;
  border-radius: 12px;
  border: 1px solid var(--border);
  width: 320px;
}
small {
  word-break: break-all;
  color: #6b7280;
}

/* ================= MOBILE (TIGHT) ================= */
@media (max-width: 768px) {
  .sidebar { display: none; }

  .messages {
    padding: 16px 12px 84px;   /* ðŸ‘ˆ mobile-safe */
  }

  .msg {
    max-width: 92%;
    font-size: 14px;
  }

  .inner {
    max-width: 100%;
  }

  .header {
    padding: 0 8px;
  }

  .input-inner {
    max-width: 100%;
  }
}
</style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <h3>Conversations</h3>
  <div class="chat-list">
    <button>Current Chat</button>
  </div>
  <button class="clear-btn" onclick="clearChat()">Clear Chat</button>
</div>

<!-- MAIN -->
<div class="main">
  <div class="header">
  ðŸ¤– Study Bot
  <div>
    <a href="/docs" target="_blank" class="docs-btn">ðŸ“„ Fast API Docs</a>
    <button onclick="toggleTheme()">ðŸŒ—</button>
    <button onclick="openProfile()">ðŸ‘¤</button>
  </div>
</div>

  <div class="messages">
    <div class="inner" id="messages"></div>
  </div>

  <div class="input">
    <div class="input-inner">
      <input id="q" placeholder="Ask a study questionâ€¦" />
      <button class="send" onclick="send()">Send</button>
    </div>
  </div>
</div>

<!-- PROFILE MODAL -->
<div class="modal" id="profileModal">
  <div class="modal-content">
    <h3>User Profile</h3>
    <p><b>User ID:</b></p>
    <small id="uid"></small>
    <br><br>
    <button onclick="closeProfile()">Close</button>
  </div>
</div>

<script>
/* USER ID */
const userId = localStorage.getItem("user_id") || crypto.randomUUID();
localStorage.setItem("user_id", userId);
document.getElementById("uid").innerText = userId;

/* THEME */
function toggleTheme() {
  document.body.classList.toggle("light");
}

/* PROFILE */
function openProfile() {
  document.getElementById("profileModal").style.display = "flex";
}
function closeProfile() {
  document.getElementById("profileModal").style.display = "none";
}

/* CHAT */
const messages = document.getElementById("messages");
const input = document.getElementById("q");

function addUserMessage(text) {
  const d = document.createElement("div");
  d.className = "msg user";
  d.textContent = text;
  messages.appendChild(d);
  messages.scrollTop = messages.scrollHeight;
}

function streamMarkdown(text) {
  const d = document.createElement("div");
  d.className = "msg bot";
  messages.appendChild(d);
  let i = 0;
  const t = setInterval(() => {
    d.innerHTML = marked.parse(text.slice(0, ++i));
    messages.scrollTop = messages.scrollHeight;
    if (i >= text.length) {
      clearInterval(t);
      d.querySelectorAll("pre code").forEach(b => hljs.highlightElement(b));
      const c = document.createElement("div");
      c.className = "copy";
      c.innerText = "Copy";
      c.onclick = () => navigator.clipboard.writeText(d.innerText);
      d.appendChild(c);
    }
  }, 15);
}

async function send() {
  const q = input.value.trim();
  if (!q) return;
  input.value = "";
  addUserMessage(q);

  try {
    const res = await fetch("/chat", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ user_id: userId, question: q })
    });
    const data = await res.json();
    streamMarkdown(data.response || data.error);
  } catch {
    streamMarkdown("âŒ Server error");
  }
}

/* CLEAR CHAT */
function clearChat() {
  messages.innerHTML = "";
}

/* ENTER TO SEND */
input.addEventListener("keydown", e => {
  if (e.key === "Enter") send();
});
</script>

</body>
</html>